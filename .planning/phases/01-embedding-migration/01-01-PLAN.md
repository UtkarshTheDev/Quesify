---
phase: 01-embedding-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [
  supabase/migrations/09_reset_embeddings_for_new_model.sql
]
autonomous: true
must_haves:
  truths:
    - All existing embeddings set to NULL
    - Database schema unchanged (still VECTOR(768))
    - Ready for gemini-embedding-001 backfill
  artifacts:
    - path: supabase/migrations/09_reset_embeddings_for_new_model.sql
      provides: Simple reset script
      contains: "UPDATE questions SET embedding = NULL"
---

<objective>
Clear all existing embeddings to prepare for regeneration with gemini-embedding-001 at 768 dimensions.

Purpose: Since we're keeping 768 dimensions (same as text-embedding-004), we only need to clear embeddings and regenerate them with the new model - NO schema changes required!

Why 768 is simpler:
- Database already has VECTOR(768) ✓
- HNSW index already exists ✓  
- match_questions_with_solutions function already uses VECTOR(768) ✓
- Just need to regenerate embeddings with new model

Output: All embeddings cleared and ready for backfill with gemini-embedding-001.
</objective>

<execution_context>
@/home/utkarsh/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
SUPER SIMPLE APPROACH - 768 dimensions:

Current state:
- Database: VECTOR(768) ✓
- Index: idx_questions_embedding ✓
- Function: match_questions_with_solutions(VECTOR(768)) ✓
- Model: text-embedding-004 (deprecated)
- Embeddings: All populated

Target state:
- Database: VECTOR(768) ✓ (NO CHANGE!)
- Index: idx_questions_embedding ✓ (NO CHANGE!)
- Function: match_questions_with_solutions(VECTOR(768)) ✓ (NO CHANGE!)
- Model: gemini-embedding-001 (new)
- Embeddings: Cleared, ready for regeneration

Benefits of keeping 768:
- No schema migration needed
- No index recreation needed
- No function updates needed
- Just: clear embeddings → regenerate with new model
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Simple Reset Script</name>
  <files>supabase/migrations/09_reset_embeddings_for_new_model.sql</files>
  <action>
    Create a simple SQL script that only clears embeddings - no schema changes needed!
    
    Since database is already VECTOR(768) and we're keeping 768 dimensions:
    - NO need to alter column type
    - NO need to drop/recreate index
    - NO need to update function signatures
    - Just clear embeddings and regenerate
    
    The script should:
    1. Check questions table exists
    2. Check embedding column exists
    3. Count questions with embeddings
    4. UPDATE questions SET embedding = NULL
    5. Verify all cleared
    6. Show instructions for next steps
    
    This is MUCH simpler than the 1536-dimension approach!
    
    Key SQL:
    ```sql
    UPDATE questions 
    SET embedding = NULL
    WHERE embedding IS NOT NULL;
    ```
    
    Add safety checks and verification.
  </action>
  <verify>Reset script created at supabase/migrations/09_reset_embeddings_for_new_model.sql</verify>
  <done>Simple reset script ready for execution</done>
</task>

<task type="auto">
  <name>Task 2: Create Rollback Script</name>
  <files>supabase/migrations/09_reset_embeddings_rollback.sql</files>
  <action>
    Create a simple rollback script.
    
    Since we're only clearing data (not changing schema), rollback means:
    - Restore from backup taken before clearing
    
    No schema changes to rollback!
    
    Document:
    - How to restore from full backup
    - How to restore from questions-only backup
    - Important: backup must be created BEFORE running reset script
  </action>
  <verify>Rollback script exists</verify>
  <done>Emergency rollback documented</done>
</task>

</tasks>

<verification>
- [ ] Reset script 09_reset_embeddings_for_new_model.sql created
- [ ] Rollback script created
- [ ] Scripts tested locally if possible
</verification>

<success_criteria>
Simple reset scripts created. Database stays at VECTOR(768), ready to regenerate embeddings with gemini-embedding-001.
</success_criteria>

<output>
After completion, create `.planning/phases/01-embedding-migration/01-01-SUMMARY.md`
</output>
